!function(){"use strict";var e={id:"anime_smart_splitter",version:"9.0",debug:!0,SEASON_GAP_DAYS:90,log:function(e,t){this.debug&&console.log("%c[SmartSplit] "+e,"background: #008080; color: #fff; padding: 2px; border-radius: 3px;",t||"")},init:function(){this.log("Плагин инициализирован. Проверка всех запросов к API."),this.interceptAjax()},interceptAjax:function(){var e=this;if(!window.$||!window.$.ajax)return setTimeout((function(){e.interceptAjax()}),200);var t=window.$.ajax;window.$.ajax=function(r,s){var i=("object"==typeof r?r:s)||{},n=(("string"==typeof r?r:i.url)||"").match(/\/tv\/(\d+)\/season\/(\d+)/);if(n){var a=n[1],o=parseInt(n[2]),u=Lampa.Storage.get("language","ru");e.log(">>> Анализ запроса: TV "+a+" Season "+o);var c=$.Deferred();t({url:"http://api.themoviedb.org/3/tv/"+a+"/season/1?api_key=4ef0d7355d9ffb5151e987764708ce96&language="+u,dataType:"json",success:function(t){var r=e.splitByDates(t.episodes||[]);if(r[o]){e.log("✅ Найдены данные для Сезона "+o+" (внутри S1). Кол-во серий: "+r[o].length);var s=e.buildSeasonObject(t,r[o],o,a);e.returnSuccess(i,c,s)}else if(o>1){e.log("⚠️ Серий по датам не найдено. Но сезон запрошен ("+o+"). Генерирую заглушки.");var n=e.generateStubs(a,o);e.returnSuccess(i,c,n)}else e.returnSuccess(i,c,t)},error:function(t,r,s){if(o>1){e.log("❌ Ошибка сети для источника. Генерирую заглушки для Сезона "+o);var n=e.generateStubs(a,o);e.returnSuccess(i,c,n)}else i.error&&i.error(t,r,s),c.reject(t,r,s)}});var p=c.promise();return p.abort=function(){},p}return t.apply(this,arguments)}},splitByDates:function(e){var t={},r=1,s=null;return e.sort(((e,t)=>e.episode_number-t.episode_number)),e.forEach((function(e){if(e.air_date){var i=new Date(e.air_date);if(s){var n=Math.abs(i-s),a=Math.ceil(n/864e5);a>this.SEASON_GAP_DAYS&&(r++,this.log("✂️ ОБНАРУЖЕН РАЗРЫВ СЕЗОНОВ: "+a+" дн. между "+s.toISOString().split("T")[0]+" и "+e.air_date),this.log("   --\x3e Эпизод "+e.episode_number+" начинает Сезон "+r))}s=i}t[r]||(t[r]=[]);var o=JSON.parse(JSON.stringify(e));o.episode_number=t[r].length+1,o.season_number=r,o.id=9e8+1e3*r+o.episode_number,t[r].push(o)}),this),t},returnSuccess:function(e,t,r){var s={responseText:JSON.stringify(r),responseJSON:r,status:200,statusText:"OK"};e.success&&e.success(r,"success",s),e.complete&&e.complete(s,"success"),t.resolve(r,"success",s)},buildSeasonObject:function(e,t,r,s){return{_id:e.id+"_smartsplit_"+r,air_date:t[0]?t[0].air_date:"2024-01-01",name:"Сезон "+r,overview:e.overview,id:e.id+555*r,poster_path:e.poster_path,season_number:r,episodes:t}},generateStubs:function(e,t){for(var r=[],s=1;s<=24;s++)r.push({air_date:"2025-01-01",episode_number:s,id:888e6+100*t+s,name:"Эпизод "+s,overview:"Серия доступна через балансер (данных в TMDB нет).",production_code:"",runtime:24,season_number:t,show_id:parseInt(e),still_path:null,vote_average:0,vote_count:0});return{_id:"stub_"+e+"_"+t,air_date:"2025-01-01",episodes:r,name:"Сезон "+t+" (Балансер)",overview:"",id:777e3+t,poster_path:null,season_number:t}}};window.appready?e.init():Lampa.Listener.follow("app",(function(t){"ready"==t.type&&e.init()}))}();
