!function(){"use strict";var e={id:"anime_smart_splitter",version:"10.0 (TV Compatibility Fix)",SEASON_GAP_DAYS:90,log:function(e,t){console.log("[SmartFix] "+e+(t?" "+JSON.stringify(t):""))},init:function(){this.log("Start Init. Compatibility mode: ES5"),this.interceptAjax()},interceptAjax:function(){var e=this;if(!window.$||!window.$.ajax)return setTimeout((function(){e.interceptAjax()}),200);this.log("jQuery found, installing hook");var t=window.$.ajax;window.$.ajax=function(a,r){var s=("object"==typeof a?a:r)||{},n=(("string"==typeof a?a:s.url)||"").match(/\/tv\/(\d+)\/season\/(\d+)/);if(n){var i=n[1],o=parseInt(n[2],10),u="undefined"!=typeof Lampa&&Lampa.Storage?Lampa.Storage.get("language","ru"):"ru";e.log("Catch Request: ID "+i+" | Season "+o);var p=$.Deferred();t({url:"http://api.themoviedb.org/3/tv/"+i+"/season/1?api_key=4ef0d7355d9ffb5151e987764708ce96&language="+u,dataType:"json",success:function(t){var a=e.processData(t,o,i),r={responseText:JSON.stringify(a),responseJSON:a,status:200,statusText:"OK"};s.success&&s.success(a,"success",r),s.complete&&s.complete(r,"success"),p.resolve(a,"success",r)},error:function(t,a,r){if(o>1){e.log("Network error or 404 on S1. Generating Stub for S"+o);var n=e.generateStubs(i,o);s.success&&s.success(n,"success",{status:200}),p.resolve(n)}else s.error&&s.error(t,a,r),p.reject(t,a,r)}});var c=p.promise();return c.abort=function(){},c}return t.apply(this,arguments)}},parseDateSafe:function(e){if(!e)return null;var t=e.split("-");return 3!==t.length?null:new Date(t[0],t[1]-1,t[2])},processData:function(e,t,a){var r=e.episodes||[],s={},n=1,i=null;r.sort((function(e,t){return e.episode_number-t.episode_number}));for(var o=0;o<r.length;o++){var u=r[o];if(u.air_date){var p=this.parseDateSafe(u.air_date);if(p&&i){var c=Math.abs(p.getTime()-i.getTime()),d=Math.ceil(c/864e5);d>this.SEASON_GAP_DAYS&&(n++,this.log("Found gap: "+d+" days. New virtual season: "+n))}p&&(i=p)}s[n]||(s[n]=[]);var l=JSON.parse(JSON.stringify(u));l.episode_number=s[n].length+1,l.season_number=n,l.id=1e7+1e4*n+l.episode_number,s[n].push(l)}var f=s[t]||[];return 0===f.length&&t>1&&(this.log("Virtual season "+t+" empty in TMDB data. Generating Stubs."),f=this.createStubEpisodes(t,a,20)),{_id:(e.id||a)+"_smart_"+t,air_date:f.length?f[0].air_date:"2025-01-01",name:"Сезон "+t,overview:e.overview||"",id:parseInt(a)+999*t,poster_path:e.poster_path,season_number:t,episodes:f}},generateStubs:function(e,t){return{_id:e+"_stub_s"+t,air_date:"2025-01-01",episodes:this.createStubEpisodes(t,e,20),name:"Сезон "+t,overview:"",id:parseInt(e)+999999,poster_path:null,season_number:t}},createStubEpisodes:function(e,t,a){for(var r=[],s=1;s<=a;s++)r.push({air_date:"2025-01-01",episode_number:s,id:8e8+1e3*e+s,name:"Episode "+s,overview:"Серия доступна для просмотра.",season_number:e,show_id:parseInt(t),still_path:null,vote_average:0});return r}},t=function(){e.init()};if("undefined"!=typeof Lampa&&Lampa.Listener)window.appready?t():Lampa.Listener.follow("app",(function(e){"ready"==e.type&&t()}));else var a=setInterval((function(){"undefined"!=typeof Lampa&&(clearInterval(a),t())}),200)}();
