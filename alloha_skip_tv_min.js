!function(){"use strict";const t=["http://online3.skaz.tv/","http://online4.skaz.tv/","http://online5.skaz.tv/"],e=t[Math.floor(Math.random()*t.length)];function a(t){let e=Lampa.Storage.get("lampac_unic_id",""),a=Lampa.Storage.get("account_email","");e||(e=Lampa.Utils.uid(8).toLowerCase(),Lampa.Storage.set("lampac_unic_id",e));const i=(t,e)=>t+(t.indexOf("?")>=0?"&":"?")+e;return-1===(t+="").indexOf("account_email=")&&(t=i(t,"account_email="+encodeURIComponent(a))),-1===t.indexOf("uid=")&&(t=i(t,"uid="+encodeURIComponent(e))),-1===t.indexOf("token=")&&(t=i(t,"token=")),t}async function i(t){try{const e=await fetch(t);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return await e.text()}catch(t){throw t}}const n=t=>new Promise((e=>setTimeout(e,t)));function s(t,e){t&&"object"==typeof t&&(t.segments||(t.segments={}),t.segments.skip||(t.segments.skip=[]),e.forEach((e=>{t.segments.skip.some((t=>t.start===e.start))||t.segments.skip.push(e)})))}async function r(t){let r=t.movie||t.card;if(!r){const t=Lampa.Activity.active();t&&(r=t.movie||t.card)}if(!r)return;let o=t.episode||t.e||t.episode_number||1,l=t.season||t.s||1;r.number_of_seasons>0||r.original_name&&!r.original_title||(l=1,o=1);const c=await async function(t,s,r){const o=t.title||t.name,l=t.original_title||t.original_name,c=(t.release_date||t.first_air_date||"0000").slice(0,4),m={id:t.id,imdb_id:t.imdb_id||"",kinopoisk_id:t.kinopoisk_id||"",title:o,original_title:l,year:c,serial:t.number_of_seasons||s>0?1:0,source:"tmdb",life:!0},u=Object.keys(m).map((t=>`${t}=${encodeURIComponent(m[t])}`)).join("&");try{let t=a(`${e}lite/events?${u}`),o=await i(t),l=JSON.parse(o),c=null;if(l.life&&l.memkey){const t=7500,s=250,r=Math.ceil(t/s);for(let t=1;t<=r;t++){await n(s);const t=a(`${e}lifeevents?memkey=${l.memkey}&${u}`);try{let e=await i(t),a=JSON.parse(e);const n=(Array.isArray(a)?a:a.online||[]).find((t=>t.name&&t.name.toLowerCase().includes("alloha")));if(n){c=n;break}}catch(t){}}}else c=(Array.isArray(l)?l:l.online||[]).find((t=>t.name&&t.name.toLowerCase().includes("alloha")));if(!c)return null;let m=a(`${c.url}${c.url.includes("?")?"&":"?"}${u}`),d=0;for(;d<5;){d++;const t=await i(m);let e=!1,n=null;if(t.trim().startsWith("{")||t.trim().startsWith("["))try{n=JSON.parse(t),e=!0}catch(t){}if(e){if(n.segments)return n.segments;if(n.url&&!n.playlist){m=a(n.url);continue}}const o=(new DOMParser).parseFromString(t,"text/html").querySelectorAll(".videos__item");if(0===o.length&&!e)break;let l=null;const c=t=>(t||"").toLowerCase().trim(),u=t=>{const e=c(t).match(/(\d+)/);return e?parseInt(e[1],10):null};for(let t=0;t<o.length;t++){const e=o[t],a=e.getAttribute("s"),i=e.getAttribute("e"),n=c(e.textContent);if(a&&i){if(a==s&&i==r){l=e;break}}else if(a){if(a==s){l=e;break}}else{if(n.includes("сезон")&&u(n)==s){l=e;break}if(n.includes("серия")&&u(n)==r){l=e;break}}}if(!l){const t=c(o[0].textContent);if(t.includes("сезон")||t.includes("серия")||o[0].hasAttribute("s")||o[0].hasAttribute("e"))break;l=o[0]}const p=l.getAttribute("data-json");if(!p)break;try{const t=JSON.parse(p);if(!t||!t.url)break;m=a(t.url)}catch(t){break}}}catch(t){}return null}(r,l,o);if(c){const e=(m=c)&&m.skip&&Array.isArray(m.skip)?m.skip.filter((t=>null!=t.start&&null!=t.end)).map((t=>({start:t.start,end:t.end,name:"Пропустить"}))):[];e.length>0&&(s(t,e),t.playlist&&Array.isArray(t.playlist)&&t.playlist.forEach((t=>{t.episode==o&&t.season==l&&s(t,e)})))}var m}function o(){if(window.lampa_alloha_skip_fixed)return;window.lampa_alloha_skip_fixed=!0;const t=Lampa.Player.play;Lampa.Player.play=function(e){Lampa.Loading.start((()=>{Lampa.Loading.stop(),t.call(this,e)})),r(e).then((()=>{Lampa.Loading.stop(),t.call(this,e)})).catch((a=>{Lampa.Loading.stop(),t.call(this,e)}))}}window.Lampa&&window.Lampa.Player?o():window.document.addEventListener("app_ready",o)}();
